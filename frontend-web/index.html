<!DOCTYPE html>
  <html>
  <head>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script type="text/javascript" src="./settings.js"></script>
    <script type="text/javascript" src="./map-styles.js"></script>
    <link rel="stylesheet" type="text/css" href="./style.css" />
    <title>Crowdsourced GeoTracker</title>
  </head>
  <body>
    <div id="map"></div>

    <script type="text/javascript">
      const isMobileDevice = (screen.width <= 768)
      let markers = {}
      let dbRequestTimeout = null
      let map = null
      let displayedTime = Math.round(Date.now() / 1000)

      // call any GET request
      function requestAPIGet (uri, params, callback) {
        var oReq = new XMLHttpRequest()
        oReq.addEventListener('load', function reqListener () {
          if (callback && this.response) callback(this.response)
        })
        oReq.open('GET', settings.backendUrl + uri + ((params && Object.keys(params) && Object.keys(params).length) ? '?' + Object.keys(params).map(k => k + '=' + params[k]).join('&') : ''))
        oReq.send()
      }

      function getMarkerColorFromType (type) {
        if (type === 'VEHICLES') return 'blue'
        if (type === 'AIRCRAFT') return 'teal'
        return 'red'
      }

      function setDisplayedTime (newTime) {
        if (displayedTime === newTime) return
        Object.keys(markers).forEach(locId => {
          markers[locId].markerObject.setMap(null)
          markers[locId].markerObject = null
        })
        markers = {}
        displayedTime = newTime
        loadReportsFromAPI()
      }

      function decrementHour () {
        setDisplayedTime(displayedTime - 3600)
      }

      function incrementHour () {
        setDisplayedTime(displayedTime + 3600)
      }

      // load reports from API, using current map's bounds
      function loadReportsFromAPI () {
        var bounds = map.getBounds()
        var ne = bounds.getNorthEast()
        var sw = bounds.getSouthWest()

        requestAPIGet ('/reports', {
          latmin: sw.lat(),
          lonmin: sw.lng(),
          latmax: ne.lat(),
          lonmax: ne.lng(),
          img: 'THUMBNAIL',
          time: displayedTime
        }, (response) => {
          const locations = JSON.parse(response)
          console.log('locations from API', displayedTime, locations)
          if (locations && locations.length) {
            locations.forEach(loc => {
              if (!markers[loc.id]) {
                markers[loc.id] = loc
                markers[loc.id].markerObject = new google.maps.Marker({
                  position: new google.maps.LatLng(loc.lat, loc.lon),
                  label: {
                    text: loc.type.toUpperCase()[0],
                    color: 'white'
                  },
                  title: loc.type.toUpperCase(),
                  map: map,
                  icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    strokeColor: getMarkerColorFromType(loc.type),
                    fillColor: getMarkerColorFromType(loc.type),
                    strokeWeight: 2,
                    fillOpacity: 0.5,
                    scale: isMobileDevice ? 30 : 9
                  }
                })
                markers[loc.id].markerObject.addListener('click', function (p) {
                  let content = ''
                  if (loc.description) content += '<div class="marker-tt-description">' + loc.description + '</div>'
                  if (loc.type) content += '<div class="marker-tt-type">' + loc.type + '</div>'
                  if (loc.lat && loc.lon) content += '<div class="marker-tt-location">' + loc.lat + ', ' + loc.lon + '</div>'
                  if (loc.type) content += '<div class="marker-tt-valid-from">' + moment(loc.valid_from).format('D. MMM. YYYY HH:mm') + '</div>'
                  markers[loc.id].markerTooltip = new google.maps.InfoWindow({
                    content
                  })
                  markers[loc.id].markerTooltip.open({
                    anchor: markers[loc.id].markerObject,
                    map,
                    shouldFocus: false
                  })
                })
              }
            })
          }
        })
      }

      function init () {
        // create the map
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: isMobileDevice ? 14 : 7,
          center: { lat: 50.41311166314775, lng: 30.46506531920826 },
          mapTypeId: 'roadmap',
          controlSize: 80,
          styles: (isMobileDevice && (moment().format('HH') >= 18 || moment().format('HH') <= 7)) ? stylesNightMode : undefined
        })

        // try to center the map on current location
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function (position) {
            var latitude = position.coords.latitude
            var longitude = position.coords.longitude
            var coords = new google.maps.LatLng(latitude, longitude)
            map.setCenter(coords)
          })
        }

        // listen for map bounds change and reload the data (at most once per 1000ms)
        google.maps.event.addListener(map, 'bounds_changed', function () {
          if (dbRequestTimeout) {
            window.clearTimeout(dbRequestTimeout)
          }
          dbRequestTimeout = window.setTimeout(loadReportsFromAPI, 1000)
        })
      }

      // load Google Maps
      var script = document.createElement('script')
      script.src = 'https://maps.googleapis.com/maps/api/js?key=' + settings.googleMapsAPIKey + '&callback=init'
      script.async = true
      document.head.appendChild(script)
    </script>
  </body>
</html>