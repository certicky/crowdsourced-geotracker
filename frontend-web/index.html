<!DOCTYPE html>
  <html>
  <head>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <script type="text/javascript" src="./settings.js"></script>
    <script type="text/javascript" src="./map-styles.js"></script>
    <link rel="stylesheet" type="text/css" href="./style.css" />
    <title>Crowdsourced GeoTracker</title>
  </head>
  <body>
    <div id="map"></div>

    <script type="text/javascript">
      const isMobileDevice = (screen.width <= 768)
      const isDarkMode = (isMobileDevice && (moment().format('HH') >= 18 || moment().format('HH') <= 7))
      let markers = {}
      let addReportMarker = null
      let addReportTooltip = null
      let dbRequestTimeout = null
      let map = null
      let displayedTime = moment().format('X')

      // call any GET request
      function requestAPIGet (uri, params, callback) {
        var oReq = new XMLHttpRequest()
        oReq.addEventListener('load', function reqListener () {
          if (callback && this.response) callback(this.response)
        })
        oReq.open('GET', settings.backendUrl + uri + ((params && Object.keys(params) && Object.keys(params).length) ? '?' + Object.keys(params).map(k => k + '=' + params[k]).join('&') : ''))
        oReq.send()
      }

      function getMarkerColorFromType (type) {
        if (type === 'VEHICLES') return 'blue'
        if (type === 'AIRCRAFT') return 'teal'
        return 'red'
      }

      function setDisplayedTime (newTime) {
        if (displayedTime === newTime) return
        Object.keys(markers).forEach(locId => {
          markers[locId].markerObject.setMap(null)
          markers[locId].markerObject = null
        })
        markers = {}
        displayedTime = newTime
        loadReportsFromAPI()
      }

      function decrementHour () {
        setDisplayedTime(displayedTime - 3600)
      }

      function incrementHour () {
        setDisplayedTime(displayedTime + 3600)
      }

      function getTweetIdFromUrl (url) {
        let urlAdjusted = url
        if (url.includes('?')) urlAdjusted = url.split('?')[0]
        const parts = urlAdjusted.split('/')
        return parts[parts.length - 1]
      }

      function closeAddReportInterface () {
        if (addReportTooltip) addReportTooltip.close()
        if (addReportMarker) { addReportMarker.setMap(null); addReportMarker = null }
      }

      // load reports from API, using current map's bounds
      function loadReportsFromAPI () {
        var bounds = map.getBounds()
        var ne = bounds.getNorthEast()
        var sw = bounds.getSouthWest()

        requestAPIGet ('/reports', {
          latmin: sw.lat(),
          lonmin: sw.lng(),
          latmax: ne.lat(),
          lonmax: ne.lng(),
          img: 'THUMBNAIL',
          time: displayedTime
        }, (response) => {
          const locations = JSON.parse(response)
          console.log('locations from API', displayedTime, locations)
          if (locations && locations.length) {
            locations.forEach(loc => {
              if (!markers[loc.id]) {
                markers[loc.id] = loc
                markers[loc.id].markerObject = new google.maps.Marker({
                  position: new google.maps.LatLng(loc.lat, loc.lon),
                  label: {
                    text: loc.type.toUpperCase()[0],
                    color: 'white'
                  },
                  title: loc.type.toUpperCase(),
                  map: map,
                  icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    strokeColor: getMarkerColorFromType(loc.type),
                    fillColor: getMarkerColorFromType(loc.type),
                    strokeWeight: 2,
                    fillOpacity: 0.5,
                    scale: isMobileDevice ? 30 : 9
                  }
                })
                markers[loc.id].markerObject.addListener('click', function (p) {
                  let content = ''
                  if (loc.description) content += '<div class="marker-tt-description">' + loc.description + '</div>'
                  if (loc.type) content += '<div class="marker-tt-type">' + loc.type + '</div>'
                  if (loc.lat && loc.lon) content += '<div class="marker-tt-location">' + loc.lat + ', ' + loc.lon + '</div>'
                  if (loc.type) content += '<div class="marker-tt-valid-from">' + moment(loc.valid_from).format('D. MMM. YYYY HH:mm') + '</div>'
                  if (loc.media_url && loc.media_url.includes('twitter.com')) {
                    content += '<div id="tweet-container-' + loc.id + '" class="marker-tt-tweet"></div>'
                    setTimeout(() => {
                      twttr.widgets.createTweet(
                        getTweetIdFromUrl(loc.media_url),
                        document.getElementById('tweet-container-' + loc.id),
                        {
                          theme: isDarkMode ? 'dark' : 'light',
                          conversation: 'none'
                        }
                      )
                    }, 500)
                  }

                  markers[loc.id].markerTooltip = new google.maps.InfoWindow({
                    content
                  })
                  markers[loc.id].markerTooltip.open({
                    anchor: markers[loc.id].markerObject,
                    map,
                    shouldFocus: false
                  })
                })
              }
            })
          }
        })
      }

      function init () {
        // create the map
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: isMobileDevice ? 14 : 7,
          center: settings.mapDefaultLocation,
          mapTypeId: 'roadmap',
          controlSize: 80,
          styles: isDarkMode ? stylesNightMode : undefined
        })

        // try to center the map on current location
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function (position) {
            var latitude = position.coords.latitude
            var longitude = position.coords.longitude
            // only center on users location if it's within the bounding box
            // defined in settings.mapCenterOnUsersLocationInBounds. otherwise,
            // remain in the default map location
            if (latitude >= settings.mapCenterOnUsersLocationInBounds.latmin && latitude <= settings.mapCenterOnUsersLocationInBounds.latmax && longitude >= settings.mapCenterOnUsersLocationInBounds.lngmin && longitude <= settings.mapCenterOnUsersLocationInBounds.lngmax) {
              var coords = new google.maps.LatLng(latitude, longitude)
              map.setCenter(coords)
              new google.maps.Marker({
                position: coords,
                map: map,
                icon: './res/bluecircle.png',
                title: 'My Location'
              })
            } else {
              console.log('Current location(' + latitude + ',' + longitude +') is outside the bounding box where auto-centering is enabled. Keeping map at a default coordinates.')
            }
          })
        }

        // listen for map bounds change and reload the data (at most once per 1000ms)
        google.maps.event.addListener(map, 'bounds_changed', function () {
          if (dbRequestTimeout) {
            window.clearTimeout(dbRequestTimeout)
          }
          dbRequestTimeout = window.setTimeout(loadReportsFromAPI, 1000)
        })

        // listen for map click and create marker + open tooltip
        google.maps.event.addListener(map, 'click', (e) => {
          closeAddReportInterface()
          addReportMarker = new google.maps.Marker({
            position: e.latLng,
            map: map,
            icon: './res/redcircle.png'
          })
          addReportTooltip = new google.maps.InfoWindow({
            content: 'adding report'
          })
          addReportTooltip.open({
            anchor: addReportMarker,
            map,
            shouldFocus: true
          })
          google.maps.event.addListener(addReportTooltip, 'closeclick', (e) => { closeAddReportInterface() })
        })
      }

      // load Google Maps
      var script = document.createElement('script')
      script.src = 'https://maps.googleapis.com/maps/api/js?key=' + settings.googleMapsAPIKey + '&callback=init'
      script.async = true
      document.head.appendChild(script)
    </script>
  </body>
</html>